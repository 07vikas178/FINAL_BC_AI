<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Patient Dashboard - Medi Fusion</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
    body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; }
    .dashboard-header h1 { font-weight: 700; color: #1d3557; }
    .card { border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: none; }
    .table-responsive { max-height: 60vh; }
    .btn-book { background-color: #2a9d8f; border-color: #2a9d8f; font-weight: 600; }
    .btn-book:hover { background-color: #264653; border-color: #264653; }
    #welcome-message { font-size: 1.25rem; }
    .card-title { font-weight: 600; }
  </style>
</head>
<body>
  <div class="container-fluid py-4">
    <header class="dashboard-header d-flex justify-content-between align-items-center mb-5 px-3">
      <h1 class="h3"><span id="welcome-message">Welcome, Patient</span></h1>
      <button id="logout-btn" class="btn btn-outline-danger">Logout</button>
    </header>

    <div class="row px-3">
      <div class="col-lg-8 mb-4">
         <div class="card mb-4">
          <div class="card-header bg-transparent border-0 pt-4 ps-4">
            <h5 class="card-title text-primary"><i class="bi bi-calendar-event me-2"></i>Your Appointments</h5>
          </div>
          <div class="card-body">
             <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr><th>Date & Time</th><th>Doctor</th><th>Status</th><th>ID</th></tr>
                </thead>
                <tbody id="appointments-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-transparent border-0 pt-4 ps-4 d-flex justify-content-between align-items-center">
                <h5 class="card-title text-success"><i class="bi bi-file-medical me-2"></i>Medical History</h5>
            </div>
            <div class="card-body">
                 <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr><th>Date</th><th>Doctor</th><th>Diagnosis</th><th>Action</th></tr>
                        </thead>
                        <tbody id="medical-history-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-transparent border-0 pt-4 ps-4">
                <h5 class="card-title text-warning"><i class="bi bi-shield-lock me-2"></i>Manage Data Privacy</h5>
            </div>
            <div class="card-body">
                <form id="consent-form">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">1. Select Hospital</label>
                            <select id="consent-hospital-select" class="form-select">
                                <option value="">-- Choose Hospital --</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">2. Select Doctor</label>
                            <select id="consent-doctor-select" class="form-select" required>
                                <option value="">-- First Choose Hospital --</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Duration</label>
                            <select id="consent-duration" class="form-select">
                                <option value="3600">1 Hour</option>
                                <option value="86400">24 Hours</option>
                                <option value="604800">1 Week</option>
                                <option value="0">Revoke Access</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-warning w-100 text-white fw-bold">Update</button>
                        </div>
                    </div>
                </form>
                <div id="consent-status-msg" class="mt-2"></div>
            </div>
        </div>

      </div>

      <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header bg-transparent border-0 pt-4 ps-4">
               <h5 class="card-title text-info">Book an Appointment</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="hospital-select" class="form-label fw-bold">1. Select a Hospital:</label>
                    <select id="hospital-select" class="form-select">
                        <option value="">-- Choose Hospital --</option>
                        </select>
                </div>

                <label class="form-label fw-bold mt-2">2. Available Doctors:</label>
                <div id="doctors-list" class="list-group list-group-flush border rounded overflow-auto" style="max-height: 300px;">
                    <div class="text-center p-3 text-muted">Please select a hospital first.</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-transparent border-0 pt-4 ps-4">
                 <h5 class="card-title text-secondary">Activity Log</h5>
            </div>
             <div class="card-body p-0">
                 <div class="table-responsive" style="max-height: 300px;">
                     <table class="table table-sm table-striped mb-0" style="font-size: 0.85rem;">
                         <thead class="table-light sticky-top">
                             <tr><th>Time</th><th>Type</th><th>By</th><th>Details</th></tr>
                         </thead>
                         <tbody id="transaction-log-body"></tbody>
                     </table>
                 </div>
             </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('token');
        if (!token) { window.location.href = '/patient_login.html'; return; }

        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            document.getElementById('welcome-message').textContent = `Welcome, ${payload.name}`;
        } catch (e) { console.error("Token error:", e); }

        // --- INITIAL LOAD ---
        loadHospitals(); 
        loadAppointments();
        loadMedicalHistory();
        loadTransactionLog();

        // --- EVENT LISTENERS ---
        // Booking Listener
        document.getElementById('hospital-select').addEventListener('change', (e) => {
            loadDoctors(e.target.value);
        });

        // Consent Listener (NEW)
        document.getElementById('consent-hospital-select').addEventListener('change', (e) => {
            loadDoctorsForConsent(e.target.value);
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = '/index.html';
        });

        // --- FUNCTIONS ---

        function loadHospitals() {
            fetch('/api/hospitals', { headers: { 'Authorization': `Bearer ${token}` } })
            .then(res => res.json())
            .then(hospitals => {
                const bookingSelect = document.getElementById('hospital-select');
                const consentSelect = document.getElementById('consent-hospital-select'); // NEW
                
                hospitals.forEach(h => {
                    // Populate Booking Dropdown
                    const option1 = document.createElement('option');
                    option1.value = h.id; 
                    option1.textContent = h.hospital_name;
                    bookingSelect.appendChild(option1);

                    // Populate Consent Dropdown (NEW)
                    const option2 = document.createElement('option');
                    option2.value = h.id; 
                    option2.textContent = h.hospital_name;
                    consentSelect.appendChild(option2);
                });

                // Check URL for pre-selected hospital
                const urlParams = new URLSearchParams(window.location.search);
                const preSelectedInfo = urlParams.get('hospital_email');
                if (preSelectedInfo) {
                    bookingSelect.value = preSelectedInfo;
                    loadDoctors(preSelectedInfo);
                }
            })
            .catch(err => console.error("Failed to load hospitals:", err));
        }

        // Logic for Booking Card (List View)
        function loadDoctors(hospitalEmail) {
            const listContainer = document.getElementById('doctors-list');
            if (!hospitalEmail) {
                listContainer.innerHTML = '<div class="text-center p-3 text-muted">Please select a hospital first.</div>';
                return;
            }

            listContainer.innerHTML = '<div class="text-center p-3">Loading doctors...</div>';

            fetch(`/api/available-doctors?hospital_email=${encodeURIComponent(hospitalEmail)}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(doctors => {
                listContainer.innerHTML = '';
                if (doctors.length === 0) {
                    listContainer.innerHTML = '<div class="text-center p-3 text-muted">No doctors available at this hospital right now.</div>';
                    return;
                }
                doctors.forEach(doc => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <div>
                            <div class="fw-bold">${doc.name}</div>
                            <div class="small text-muted">${doc.specialization}</div>
                        </div>
                        <a href="/book_appointment.html?doctorId=${doc.doctor_id}&hospitalEmail=${encodeURIComponent(hospitalEmail)}" class="btn btn-sm btn-book text-white">Book</a>
                    `;
                    listContainer.appendChild(item);
                });
            })
            .catch(err => {
                console.error(err);
                listContainer.innerHTML = '<div class="text-danger p-3 text-center">Failed to load doctors.</div>';
            });
        }

        // Logic for Consent Card (Dropdown View) - NEW FUNCTION
        function loadDoctorsForConsent(hospitalEmail) {
            const select = document.getElementById('consent-doctor-select');
            
            if (!hospitalEmail) {
                select.innerHTML = '<option value="">-- First Choose Hospital --</option>';
                return;
            }

            select.innerHTML = '<option value="">Loading...</option>';

            fetch(`/api/available-doctors?hospital_email=${encodeURIComponent(hospitalEmail)}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(doctors => {
                select.innerHTML = '<option value="">-- Select Doctor --</option>';
                if (doctors.length === 0) {
                    const opt = document.createElement('option');
                    opt.textContent = "No doctors available";
                    select.appendChild(opt);
                    return;
                }
                doctors.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.doctor_id; // This is the email
                    option.textContent = `${doc.name} (${doc.specialization})`;
                    select.appendChild(option);
                });
            })
            .catch(err => {
                console.error(err);
                select.innerHTML = '<option value="">Error loading doctors</option>';
            });
        }

        function loadAppointments() {
            fetch('/api/my-patient-appointments', { headers: { 'Authorization': `Bearer ${token}` } })
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('appointments-body');
                tbody.innerHTML = '';
                
                if(data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No appointments found.</td></tr>';
                } else {
                    data.forEach(app => {
                        let statusClass = app.status === 'Approved' ? 'bg-success' : (app.status === 'Rejected' ? 'bg-danger' : 'bg-warning text-dark');
                        tbody.innerHTML += `
                            <tr>
                                <td>${new Date(app.appointment_time).toLocaleString()}</td>
                                <td>Dr. ${app.doctor_name}</td>
                                <td><span class="badge ${statusClass}">${app.status}</span></td>
                                <td><small class="text-muted">${app.appointment_id.substring(0, 8)}...</small></td>
                            </tr>`;
                    });
                }
            });
        }

        function loadMedicalHistory() {
            fetch('/api/my-prescriptions', { headers: { 'Authorization': `Bearer ${token}` } })
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('medical-history-body');
                tbody.innerHTML = '';
                if(data.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No medical records found.</td></tr>';
                     return;
                }
                data.forEach((rec, index) => {
                     tbody.innerHTML += `
                        <tr>
                            <td>${new Date(Number(rec.timestamp)).toLocaleDateString()}</td>
                            <td>Dr. ${rec.doctorName}</td>
                            <td>${rec.disease}</td>
                            <td><button class="btn btn-sm btn-outline-primary" onclick="viewPrescription(${index})">View</button></td>
                        </tr>`;
                });
                window.prescriptions = data; 
            });
        }

        window.viewPrescription = function(index) {
            const rec = window.prescriptions[index];
            localStorage.setItem('current_prescription', JSON.stringify(rec));
            window.location.href = '/view_document.html';
        };

        function loadTransactionLog() {
            fetch('/api/transaction-log', { headers: { 'Authorization': `Bearer ${token}` } })
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('transaction-log-body');
                tbody.innerHTML = '';
                if (!data.log || data.log.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No activity yet.</td></tr>'; return;
                }
                const typeMap = ['Booked', 'Accessed', 'Updated', 'Consent'];
                data.log.slice().reverse().forEach(log => {
                    tbody.innerHTML += `<tr>
                        <td>${new Date(Number(log.timestamp) * 1000).toLocaleDateString()}</td>
                        <td><span class="badge bg-secondary">${typeMap[log.logType] || 'Log'}</span></td>
                        <td class="text-truncate" style="max-width: 100px;" title="${log.performedBy}">${log.performedBy}</td>
                        <td class="text-truncate" style="max-width: 150px;" title="${log.details}">${log.details}</td>
                    </tr>`;
                });
            });
        }
        
        // --- Handle Consent Submit ---
        document.getElementById('consent-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const doctorEmail = document.getElementById('consent-doctor-select').value;
            const duration = document.getElementById('consent-duration').value;
            const msgDiv = document.getElementById('consent-status-msg');
            
            if(!doctorEmail) { alert("Please select a doctor."); return; }

            const status = duration === "0" ? "Revoked" : "Granted";
            const finalDuration = duration === "0" ? 0 : duration;

            msgDiv.innerHTML = '<span class="text-info">Processing on Blockchain...</span>';

            fetch('/api/manage-consent', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    doctorEmail: doctorEmail,
                    duration: finalDuration,
                    status: status,
                    accessLevel: "View History"
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.error) throw new Error(data.error);
                msgDiv.innerHTML = `<span class="text-success fw-bold">${data.message}</span>`;
                loadTransactionLog(); // Refresh logs
            })
            .catch(err => {
                console.error(err);
                msgDiv.innerHTML = `<span class="text-danger">Error: ${err.message}</span>`;
            });
        });
    });
  </script>
</body>
</html>